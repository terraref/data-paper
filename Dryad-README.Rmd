---
title: 'Data From: TERRA REF, An Open Reference Data Set From High Resolution Genomics,
  Phenomics, and Imaging Sensors'
author: "David LeBauer, long list TBD"
date: "2/10/2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, cache = FALSE, message = FALSE)

library(traits)
library(dplyr)
library(stringr)

options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
        betydb_api_version = 'v1',
        betydb_key = readLines('~/.betykey', warn = FALSE))
```


```{r eml-metadata}
library(EML)
dsl <- eml$creator(individualName = eml$individualName(givenName = "David",
                                                       surName = "LeBauer"),
                   organizationName = "University of Arizona",
                   electronicMailAddress = "dlebauer@arizona.edu",
                   userId = list(directory = "https://orcid.org",
                                 userId    = "https://orcid.org/0000-0001-7228-053X"))
                   
doc <- list(packageId = "dataset-1", system = "Dryad",
            dataset = eml$dataset(
              title = "Data From: TERRA REF, An Open Reference Data Set From High Resolution Genomics, Phenomics, and Imaging Sensors",
              creator = dsl,
              contact = dsl))

```

## Abstract

```{r abstract, results = 'asis'}
abstract <- EML::set_TextType("metadata/abstract.md")
class(abstract) <- 'abstract'
doc$dataset$abstract <- abstract
writeLines(readLines('metadata/abstract.md'))
```

## Usage Notes

1. Technical Documentation
  * website: https://docs.terraref.org/
  * source: github.com/terraef/documentation
  * archive: David LeBauer, Craig Willis, Rachel Shekar, Max Burnette, Ting Li, Scott Rohde, et al. 2020. “Terraref/documentation: Season 6 Data Publication (2019)”. Zenodo. doi:10.5281/zenodo.597425
2. Tutorials: Tutorials for accessing and understanding data
  * website: https://terraref.org/tutorials
  * source: github.com/terraref/tutorials
  * archive: TBD
  * YouTube: https://www.youtube.com/channel/UComeQAqYR5aZrXN_3K5iFGw

## Contents

### Plot level phenotype data 

*files* 
* season_4_traits.csv.zip 
* season_6_traits.csv.zip

*format* csv with the following fields:

* plot 
* lat
* lon
* scientificname
* genotype
* season
* treatment
* date
* time
* year
* month
* trait
* method
* mean
* checked: has this record been checked? 0 = No, 1 = Yes, 
* notes
* author
* method_type

## Methods

```{r location}
mac_field <- betydb_query(table = 'sites', sitename = '~MAC Field Scanner Field')
library(sf)

mac_bounds <- st_bbox(st_as_sfc(mac_field$geometry))

sorghum <- betydb_query(table = 'species', genus = 'Sorghum')

species <-   data.frame(Genus = sorghum$genus, 
                          Species = sorghum$scientificname)

doc$dataset$coverage <- set_coverage(beginDate = "2017-04-13",
                                     endDate = "2018-08-02",
                                     geographicDescription   = "Maricopa Agricultural Center, Maricopa, AZ",
                                     sci_names = species,
                                     westBoundingCoordinate  = mac_bounds['xmin'],
                                     eastBoundingCoordinate  = mac_bounds['xmax'],
                                     northBoundingCoordinate = mac_bounds['ymax'],
                                     southBoundingCoordinate = mac_bounds['ymin']
                                     )
                                     
                                     
```


### Experimental Design

```{r experimental-design, results = 'asis'}

writeLines(readLines('metadata/experiments.md'))
```

```{r methods-eml}
doc$dataset$methods <- EML::set_methods(
  sampling_file = 'metadata/experiments.md',
  methods_file = 'metadata/methods.md')
```

### Accessions

Here we use the terms 'germplasm', 'cultivars', and 'accessions' to refer to the distinct plant genotypes that are the key unit of experimental investigations in breeding trials.

```{r cultivars, eval=FALSE}

writeLines(readLines('metadata/germplasm.md'))
```


```{r cultivars-eml}
# atts_shiny <- EML::shiny_attributes(readr::read_csv('data/germplasm.csv'))

doc$dataset$dataTable <- eml$dataTable(
  entityName = 'metadata/germplasm.csv',
  entityDescription = paste0("List of Sorghum genotypes ('accessions')",
                             "and experiments in which they were included"))

#atts <- read.csv('metadata/germplasm_Attributes_Table.csv')
#doc$dataset$dataTable$attributeList <- set_attributes(atts)
```

```{r}
eml_validate(doc)
write_eml(doc, "metadata/eml_metadata.xml")
```

## Sensor Derived Phenotypes

The following records were generated from sensors by algorithms:

```{r sensor-data}
trait_counts <- readr::read_csv('metadata/trait_counts.csv')

sensor_methods <- c("Green Canopy Cover Estimation from Field Scanner RGB images", 
"3D scanner to 98th quantile height", "Scanner 3d ply data to height", 
"Stereo RGB data to emergence count", "3D scanner to leaf angle distribution", 
"3D scanner to leaf length and width", "3D scanner to panicle count faster_rcnn + roughness threshold + convex hull", "Mean temperature from infrared images")

trait_counts %>% 
  filter(method_name %in% sensor_methods) %>% 
  arrange(desc(n)) %>% 
  knitr::kable()
```
```{r manual-data-counts}
trait_counts %>% 
  filter(!method_name %in% sensor_methods) %>%
  arrange(desc(n)) %>% 
  knitr::kable()
```

### Varables and Methods

Below we provide details about each variable and method.

```{r}
writeLines(readLines('metadata/variables.md'))
```

### Methods

```{r}
writeLines(readLines('metadata/methods.md'))
```

