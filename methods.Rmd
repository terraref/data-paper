---
title: "Methods"
author: "David LeBauer"
date: "2/12/2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r settings, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, message = FALSE)
```


### Note on accessing data and metadata from BETYdb

Data can be queried using the traits package, but it is much slower (hours to get all of the data). Especially when joining tables. To use the API, adding `associations_mode = ids` will return the keys required to join tables. See terraref.org/tutorials for more information.

To query the database follow the instructions at github.com either use `ssh -Nf -L 5432:localhost:5432 bety6.ncsa.illinois.edu` or follow the instructions for installing the BRAPI endpoint.


```{r}
library(traits)
library(dplyr)
library(stringr)

# to query the database either use 
# ssh -Nf -L 5432:localhost:5432 bety6.ncsa.illinois.edu 
# to mount the database

#options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
#        betydb_api_version = 'v1',
#        betydb_key = readLines('~/.betykey', warn = FALSE))
bety_src <- src_postgres(dbname = "bety", 
                         password = 'DelchevskoOro', 
                         host = 'localhost', 
                         user = 'viewer', 
                         port = 5432)

```


## Experiments


```{r experiments, cache = FALSE}
experiments <- tbl(bety_src, 'experiments') %>%
  dplyr::select(experiment_id = id, start_date, end_date, name, description, design)

experiments_subset <- experiments %>% 
  select(experiment_id, name, Start = start_date, Harvest = end_date, Summary = description, Design = design) %>% 
  collect() %>% 
  filter(str_detect(name,"Season 4|Season 6")) %>% 
  filter(str_detect(name, "Border Plots", negate = TRUE)) %>% 
  tidyr::separate(name, c('Season', 'Experiment'), sep = ":") 

descriptions <- experiments_subset %>% 
  #tidyr::replace_na(list(author = "", year = "", title = "", journal = "")) %>% 
  rowwise() %>% 
  transmute( paste("\n#### ", Season, "\n\n",
                   "* Start:", Start, "\n",
                   "* End:", Harvest,"\n\n",
                   Summary, "\n\n",
                   "Experimental Design: ", Design, "\n"))

writeLines(unlist(descriptions), con = 'metadata/experiments.md')
```


```{r}
experiments_treatments <- tbl(bety_src, 'experiments_treatments') %>%
  dplyr::select(experiment_id, treatment_id)

experiments_treatments_subset <- experiments_subset %>% 
  left_join(experiments_treatments, by = 'experiment_id', copy = TRUE)

treatments <- tbl(bety_src, 'treatments') %>%
  dplyr::select(treatment_id = id , name, definition, control)

managements_treatments <- tbl(bety_src, 'managements_treatments') %>% 
  dplyr::select(treatment_id, management_id)

managements <- tbl(bety_src, 'managements') %>%
  dplyr::select(management_id = id, date, mgmttype, level, units, notes)

managementsplus <- managements %>%
  left_join(managements_treatments, by = 'management_id') %>%
  left_join(treatments, by = 'treatment_id') %>% 



```

### Germplasm

```{r germplasm}
library(jsonlite)
season_6 <-  betydb_query(table = 'experiments', name = 'MAC Season 6: Sorghum BAP')
season_4 <-  betydb_query(table = 'experiments', name = 'MAC Season 4: All BAP Accessions')

download.file(
  paste0("https://brapi.workbench.terraref.org/brapi/v1/studies/",
         season_4$id,"/germplasm"), 
    destfile = 'metadata/season_4_germplasm.json')
download.file(
  paste0("https://brapi.workbench.terraref.org/brapi/v1/studies/",
         season_6$id,"/germplasm"), 
    destfile = 'metadata/season_6_germplasm.json')

s4 <- fromJSON('metadata/season_4_germplasm.json', flatten = TRUE)$result$data %>%
  select(germplasmName, germplasmPUI) %>% 
  mutate(season_4 = TRUE)
s6 <- fromJSON('metadata/season_6_germplasm.json', flatten = TRUE)$result$data %>%
  select(germplasmName, germplasmPUI) %>% 
  mutate(season_6 = TRUE)
germplasm_list <- s4 %>% 
  dplyr::full_join(s6, by = c('germplasmName', 'germplasmPUI')) 

readr::write_csv(germplasm_list, 'metadata/germplasm.csv')

germplasm_table <- readr::read_csv('metadata/germplasm.csv') %>% 
  knitr::kable()

germplasm_text <- c("### Germplasm \n\n A list of cultivars and the experiments in which they are planted are listed in the table below, from the file 'germplasm.csv'. Additional attributes are listed in the files 'season_4_germplasm.json' and 'season_6_germplasm.json'.\n\n", 
                        germplasm_table)

writeLines(germplasm_text, 'metadata/germplasm.md')

```

## Methods

```{r methods}
variables <- betydb_query(table = 'variables', limit = 'none')
methods <- betydb_query(table = 'methods', limit = 'none')

## join w/ s6, s4 data then re-save
save(methods, variables, file = 'metadata/methods_variables.RData')

s4 <- list()
for (f in dir("data/season_4_traits/", full.names = TRUE, pattern = 'csv')){
  s4[[f]] <- readr::read_csv(f)
}

s4 <- dplyr::bind_rows(s4)
save(s4, file = 'data/s4.RData')

s6 <- list()
for (f in dir("data/season_6_traits/", full.names = TRUE, pattern = 'csv')){
  s6[[f]] <- readr::read_csv(f)
}

s6 <- dplyr::bind_rows(s6)
save(s6, file = 'data/s6.RData')

s46 <- dplyr::bind_rows(
  cbind(season = 4, s4), 
  cbind(season = 6, s6))


sensor_methods <- c("Green Canopy Cover Estimation from Field Scanner RGB images", 
"3D scanner to 98th quantile height", "Scanner 3d ply data to height", 
"Stereo RGB data to emergence count", "3D scanner to leaf angle distribution", 
"3D scanner to leaf length and width", "3D scanner to panicle count faster_rcnn + roughness threshold + convex hull", "Mean temperature from infrared images")

s46_subset <- s46 %>% 
  dplyr::select(plot = sitename, lat, lon, scientificname, genotype = cultivar, season, treatment, date, time, year, month, trait, method = method_name, mean, checked, notes, author) %>% 
  dplyr::mutate(method_type = ifelse(method %in% sensor_methods, 'sensor', 'manual'))

readr::write_csv(
  s46_subset %>% filter(season == 4), 
  'data/season_4_traits.csv')

readr::write_csv(
  s46_subset %>% filter(season == 6), 
  'data/season_6_traits.csv')
```

```{r s46methods}
library(dplyr) 
trait_counts <- s46 %>% 
  group_by(trait, method_name) %>% 
  tally()
readr::write_csv(trait_counts, 'metadata/trait_counts.csv')

v <- variables %>% 
  select(label, name, description, units, notes, n = `number of associated traits`)  %>% 
  filter(name %in% unique(s46$trait))

c <- betydb_query(table = 'citations', limit = 'none') %>% 
  select(author, year, title, journal, citation_id = id)
m <- methods %>% 
  left_join(c, by = 'citation_id') %>% 
  filter(name %in% unique(s46$method_name)) %>% 
  select(name, description, author, title, year, journal, 
         n = `number of associated traits`)

readr::write_csv(m, 'metadata/methods.csv')
readr::write_csv(v, 'metadata/variables.csv')

```

```{r methods.md}
methods_text <- m %>% 
  tidyr::replace_na(list(author = "", year = "", title = "", journal = "")) %>% 
  rowwise() %>% 
  transmute(paste("\n###", name, "\n\n",
                  "citation: ", author, year, title, journal, "\n\n",
                  "total observations: ", n, "\n\n",
                  description,
                  "associated variable(s):", paste(trait_counts %>% filter(method_name == name) %>% select(trait), sep = ','), "\n\n"
                  ))
writeLines(unlist(methods_text), con = 'metadata/methods.md')
```

```{r variables.md}
variables_text <- v %>% 
#  tidyr::replace_na(list(author = "", year = "", title = "", journal = "")) %>% 
  rowwise() %>% 
  transmute(paste0("\n### ", label, "(",units,")","\n\n",
                   "name: ", name,
                   description, "\n\n",
                   "_notes_: _", notes, "_"))
writeLines(unlist(variables_text), con = 'metadata/variables.md')
```